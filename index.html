<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Assignment 2 - Interactive Map</title>
    
    <!-- OpenLayers ÿßÿ≤ CDN ŸÇÿßÿ®ŸÑ ÿßÿπÿ™ŸÖÿßÿØ -->
    <link rel="stylesheet" href="https://openlayers.org/en/v6.15.1/css/ol.css" type="text/css">
    <script src="https://openlayers.org/en/v6.15.1/build/ol.js" type="text/javascript"></script>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ÿßÿ≥ÿ™ÿß€åŸÑ‚ÄåŸáÿß€å ÿØÿßÿÆŸÑ€å */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
        }
        
        .search-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .weather-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }
        
        .coordinates-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-top: 20px;
        }
        
        .status-bar {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            border: 1px solid #dee2e6;
        }
        
        .weather-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .temperature {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .detail-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .detail-label {
            font-size: 12px;
            color: #666;
        }
        
        .detail-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .ol-control {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border-radius: 8px !important;
            padding: 5px !important;
        }
        
        .ol-control button {
            background-color: #3498db !important;
            color: white !important;
            border-radius: 5px !important;
            margin: 2px !important;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .map-container {
                height: 400px;
            }
            
            .weather-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ŸáÿØÿ± -->
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-globe-americas"></i> WebGIS Assignment 2</h1>
            <p class="lead mb-0">Interactive Map with Geocoding & Weather Data</p>
        </div>
    </div>

    <div class="container">
        <!-- ÿ¨ÿ≥ÿ™ÿ¨Ÿà -->
        <div class="search-box">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="search-input"
                               placeholder="Search for a city, address, or landmark...">
                        <button class="btn btn-custom" id="search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button class="btn btn-success btn-custom" id="geolocation-btn">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="row">
                        <div class="col-6">
                            <select class="form-select" id="base-layer">
                                <option value="osm">OpenStreetMap</option>
                                <option value="carto">Dark Map</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="temperature-unit">
                                <option value="celsius">¬∞C</option>
                                <option value="fahrenheit">¬∞F</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ŸÖÿ≠ÿ™Ÿàÿß€å ÿßÿµŸÑ€å -->
        <div class="row">
            <!-- ŸÜŸÇÿ¥Ÿá -->
            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow">
                    <div class="card-body p-0">
                        <div id="map" class="map-container"></div>
                    </div>
                </div>
            </div>

            <!-- ÿ¢ÿ®‚ÄåŸàŸáŸàÿß -->
            <div class="col-lg-4 mb-4">
                <div class="weather-panel">
                    <h4><i class="fas fa-cloud-sun text-primary"></i> Weather Information</h4>
                    
                    <div id="weather-info" class="my-4">
                        <div class="text-center py-4">
                            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Weather Data Yet</h5>
                            <p class="text-muted small">
                                Search for a location or click on the map
                            </p>
                        </div>
                    </div>

                    <!-- ŸÖÿÆÿ™ÿµÿßÿ™ -->
                    <div class="coordinates-display">
                        <h6><i class="fas fa-crosshairs"></i> Current Location</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Latitude</small>
                                <div class="fw-bold" id="current-lat">0.0000</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Longitude</small>
                                <div class="fw-bold" id="current-lon">0.0000</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Last Updated:</small>
                            <div id="last-updated" class="fst-italic">-</div>
                        </div>
                    </div>

                    <!-- ⁄©ŸÜÿ™ÿ±ŸÑ‚ÄåŸáÿß -->
                    <div class="mt-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="reset-view">
                                <i class="fas fa-sync-alt"></i> Reset View
                            </button>
                            <button class="btn btn-outline-danger" id="clear-markers">
                                <i class="fas fa-trash-alt"></i> Clear Markers
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ŸÜŸàÿßÿ± Ÿàÿ∂ÿπ€åÿ™ -->
        <div class="status-bar">
            <div class="row">
                <div class="col-md-4">
                    <i class="fas fa-map-marker-alt text-primary"></i>
                    Coordinates: <span id="coordinates" class="fw-bold">0.0000, 0.0000</span>
                </div>
                <div class="col-md-4 text-center">
                    <i class="fas fa-search text-info"></i>
                    Zoom: <span id="zoom-level" class="fw-bold">2</span>
                </div>
                <div class="col-md-4 text-end">
                    <span id="api-status" class="text-success">
                        <i class="fas fa-check-circle"></i> Ready
                    </span>
                </div>
            </div>
        </div>

        <!-- ÿßÿ∑ŸÑÿßÿπÿßÿ™ API -->
        <div class="alert alert-light mt-3">
            <div class="row">
                <div class="col-md-6">
                    <i class="fas fa-map-pin text-primary"></i>
                    <strong>Geocoding API:</strong> LocationIQ
                    <span class="badge bg-success ms-2">Active</span>
                </div>
                <div class="col-md-6">
                    <i class="fas fa-cloud text-info"></i>
                    <strong>Weather API:</strong> OpenWeatherMap
                    <span class="badge bg-success ms-2">Active</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ÿßÿ≥⁄©ÿ±€åŸæÿ™ ÿßÿµŸÑ€å -->
    <script>
        // ============================================================================
        // CONFIGURATION - API KEYS
        // ============================================================================
        const API_KEYS = {
            GEOCODING: 'pk.a05a2a206bdbbeee36d4e7d50caa01e2',
            WEATHER: '4f43c790958b3fb1edbbae26fae4ee78'
        };

        // ============================================================================
        // GLOBAL VARIABLES
        // ============================================================================
        let map;
        let markerSource;
        let markerLayer;

        // ============================================================================
        // INITIALIZE MAP (OpenLayers v6.15.1)
        // ============================================================================
        function initMap() {
            console.log('Initializing OpenLayers map v6.15.1...');
            
            try {
                // Create marker source
                markerSource = new ol.source.Vector();
                
                // Create marker layer
                markerLayer = new ol.layer.Vector({
                    source: markerSource,
                    style: new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 8,
                            fill: new ol.style.Fill({
                                color: 'rgba(255, 0, 0, 0.8)'
                            }),
                            stroke: new ol.style.Stroke({
                                color: 'rgba(255, 255, 255, 1)',
                                width: 2
                            })
                        })
                    })
                });

                // Create base layers
                const osmLayer = new ol.layer.Tile({
                    source: new ol.source.OSM(),
                    visible: true
                });

                const cartoLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
                    }),
                    visible: false
                });

                // Create view centered on London
                const view = new ol.View({
                    center: ol.proj.fromLonLat([-0.09, 51.505]),
                    zoom: 10,
                    maxZoom: 18,
                    minZoom: 2
                });

                // Create the map
                map = new ol.Map({
                    target: 'map',
                    layers: [osmLayer, cartoLayer, markerLayer],
                    view: view,
                    controls: ol.control.defaults().extend([
                        new ol.control.ScaleLine(),
                        new ol.control.ZoomSlider(),
                        new ol.control.FullScreen(),
                        new ol.control.MousePosition({
                            coordinateFormat: ol.coordinate.createStringXY(4),
                            projection: 'EPSG:4326'
                        })
                    ])
                });

                // Update coordinates on mouse move
                map.on('pointermove', function(evt) {
                    if (evt.dragging) return;
                    const coord = ol.proj.toLonLat(evt.coordinate);
                    document.getElementById('coordinates').textContent = 
                        coord[1].toFixed(4) + ', ' + coord[0].toFixed(4);
                });

                // Update zoom level
                map.getView().on('change:resolution', function() {
                    const zoom = Math.round(this.getZoom());
                    document.getElementById('zoom-level').textContent = zoom;
                });

                // Add click handler for weather
                map.on('click', handleMapClick);

                console.log('‚úÖ Map initialized successfully!');
                updateStatus('Map ready - Search or click on map', 'success');

            } catch (error) {
                console.error('‚ùå Map initialization error:', error);
                alert('Error initializing map. Please check console for details.');
            }
        }

        // ============================================================================
        // GEOCODING FUNCTION
        // ============================================================================
        async function geocodeLocation(searchTerm) {
            try {
                updateStatus('Searching location...', 'info');
                
                const url = `https://us1.locationiq.com/v1/search.php?key=${API_KEYS.GEOCODING}&q=${encodeURIComponent(searchTerm)}&format=json&limit=1`;
                
                console.log('Fetching:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    throw new Error('Location not found');
                }
                
                const location = data[0];
                const lon = parseFloat(location.lon);
                const lat = parseFloat(location.lat);
                
                console.log('Found location:', location.display_name);
                console.log('Coordinates:', lat, lon);
                
                // Add marker to map
                addMarker([lon, lat], location.display_name);
                
                // Get weather for this location
                await fetchWeatherData(lat, lon);
                
                updateStatus(`Found: ${location.display_name.split(',')[0]}`, 'success');
                
                return [lon, lat];
                
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error: ' + error.message + '\nPlease try a different search term.');
                updateStatus('Search failed', 'error');
                return null;
            }
        }

        // ============================================================================
        // WEATHER FUNCTION
        // ============================================================================
        async function fetchWeatherData(lat, lon) {
            try {
                updateStatus('Fetching weather...', 'info');
                
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEYS.WEATHER}&units=metric`;
                
                console.log('Fetching weather from:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('Weather data received:', data);
                
                // Display weather
                displayWeather(data);
                
                // Update location info
                document.getElementById('current-lat').textContent = lat.toFixed(4);
                document.getElementById('current-lon').textContent = lon.toFixed(4);
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
                updateStatus('Weather loaded successfully', 'success');
                
            } catch (error) {
                console.error('Weather error:', error);
                displayError('Failed to get weather: ' + error.message);
                updateStatus('Weather failed', 'error');
            }
        }

        // ============================================================================
        // WEATHER DISPLAY
        // ============================================================================
        function displayWeather(data) {
            const weatherHTML = `
                <div class="weather-card">
                    <div class="weather-icon-large mb-3">
                        ${getWeatherIcon(data.weather[0].main)}
                    </div>
                    <div class="temperature">
                        ${Math.round(data.main.temp)}¬∞C
                    </div>
                    <div class="mb-3">
                        ${data.weather[0].description}
                        <div class="small">${data.name || 'Unknown location'}</div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="detail-item">
                            <div class="detail-label">Feels Like</div>
                            <div class="detail-value">${Math.round(data.main.feels_like)}¬∞C</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Humidity</div>
                            <div class="detail-value">${data.main.humidity}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pressure</div>
                            <div class="detail-value">${data.main.pressure} hPa</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Wind Speed</div>
                            <div class="detail-value">${data.wind.speed} m/s</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('weather-info').innerHTML = weatherHTML;
        }

        function displayError(message) {
            document.getElementById('weather-info').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function getWeatherIcon(condition) {
            const cond = condition.toLowerCase();
            if (cond.includes('clear')) return '‚òÄÔ∏è';
            if (cond.includes('cloud')) return '‚òÅÔ∏è';
            if (cond.includes('rain')) return 'üåßÔ∏è';
            if (cond.includes('snow')) return '‚ùÑÔ∏è';
            if (cond.includes('storm')) return '‚õàÔ∏è';
            return 'üåà';
        }

        // ============================================================================
        // MARKER FUNCTIONS
        // ============================================================================
        function addMarker(coords, label) {
            // Clear existing markers
            markerSource.clear();
            
            // Create new marker
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat(coords))
            });
            
            marker.setStyle(new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 10,
                    fill: new ol.style.Fill({
                        color: 'rgba(231, 76, 60, 0.8)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'rgba(255, 255, 255, 1)',
                        width: 3
                    })
                })
            }));
            
            markerSource.addFeature(marker);
            
            // Animate to marker
            map.getView().animate({
                center: ol.proj.fromLonLat(coords),
                zoom: 12,
                duration: 1000
            });
            
            console.log('Marker added at:', coords);
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================
        async function handleMapClick(event) {
            const coords = ol.proj.toLonLat(event.coordinate);
            const [lon, lat] = coords;
            
            console.log('Map clicked at:', lat, lon);
            
            // Update coordinates display
            document.getElementById('coordinates').textContent = 
                lat.toFixed(4) + ', ' + lon.toFixed(4);
            
            // Add marker
            addMarker([lon, lat], 'Clicked location');
            
            // Fetch weather
            await fetchWeatherData(lat, lon);
        }

        function handleSearch() {
            const input = document.getElementById('search-input');
            const term = input.value.trim();
            
            if (!term) {
                alert('Please enter a location to search');
                input.focus();
                return;
            }
            
            console.log('Searching for:', term);
            geocodeLocation(term);
            input.value = '';
        }

        function handleGeolocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            updateStatus('Getting your location...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    console.log('Got location:', lat, lon);
                    
                    // Update display
                    document.getElementById('coordinates').textContent = 
                        lat.toFixed(4) + ', ' + lon.toFixed(4);
                    
                    // Add marker
                    addMarker([lon, lat], 'My Location');
                    
                    // Fetch weather
                    await fetchWeatherData(lat, lon);
                    
                    updateStatus('Found your location', 'success');
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    let message = 'Unable to get your location. ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Permission denied.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Position unavailable.';
                            break;
                        case error.TIMEOUT:
                            message += 'Request timeout.';
                            break;
                        default:
                            message += 'Unknown error.';
                    }
                    
                    alert(message);
                    updateStatus('Location failed', 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        function updateStatus(message, type) {
            const statusEl = document.getElementById('api-status');
            
            // Remove existing classes
            statusEl.className = '';
            
            // Add appropriate class
            switch(type) {
                case 'success':
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
                    statusEl.classList.add('text-success');
                    break;
                case 'error':
                    statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
                    statusEl.classList.add('text-danger');
                    break;
                case 'info':
                    statusEl.innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
                    statusEl.classList.add('text-info');
                    break;
                default:
                    statusEl.innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
                    statusEl.classList.add('text-secondary');
            }
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        function initApp() {
            console.log('üöÄ Starting WebGIS Application...');
            
            try {
                // Initialize map first
                initMap();
                
                // Setup event listeners
                document.getElementById('search-btn').addEventListener('click', handleSearch);
                
                document.getElementById('search-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') handleSearch();
                });
                
                document.getElementById('geolocation-btn').addEventListener('click', handleGeolocation);
                
                document.getElementById('reset-view').addEventListener('click', function() {
                    map.getView().animate({
                        center: ol.proj.fromLonLat([-0.09, 51.505]),
                        zoom: 10,
                        duration: 1000
                    });
                    markerSource.clear();
                    updateStatus('Map view reset', 'info');
                });
                
                document.getElementById('clear-markers').addEventListener('click', function() {
                    markerSource.clear();
                    updateStatus('Markers cleared', 'info');
                });
                
                document.getElementById('base-layer').addEventListener('change', function(e) {
                    const layers = map.getLayers().getArray();
                    layers[0].setVisible(e.target.value === 'osm');
                    layers[1].setVisible(e.target.value === 'carto');
                });
                
                document.getElementById('temperature-unit').addEventListener('change', function(e) {
                    updateStatus(`Temperature unit: ${e.target.value}`, 'info');
                });
                
                console.log('‚úÖ Application initialized successfully!');
                
            } catch (error) {
                console.error('‚ùå Application initialization error:', error);
                alert('Failed to initialize application. Please check console.');
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>
